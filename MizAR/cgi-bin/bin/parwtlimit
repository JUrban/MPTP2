#!/usr/bin/perl -w

# parallelizes vampire with four different extensions, the biggest is run with -sd 1

use strict;
my $tl = 1 + shift @ARGV;
my $prog = shift @ARGV;
my $filestem = shift @ARGV;
# my $vampire_params_sd  = shift @ARGV;  
my $vampire_params2 = join(' ', @ARGV);
my $vampire_params_sd = " -ss included -sd "; # the -d sine param without a number
my @smallextensions = ('', '.big0', '.big1'); 
my $bigext = '.big';

for my $ext (@smallextensions)
{
#    print("ulimit -t $tl; $prog $vampire_params2 $filestem$ext > $filestem$ext.eout1 & ");
    system("ulimit -t $tl; $prog $vampire_params2 $filestem$ext > $filestem$ext.eout1 & ");
}


system("ulimit -t $tl; $prog $vampire_params_sd 1 $vampire_params2 $filestem$bigext > $filestem$bigext.eout1 & ");

my $num = $tl+1;
while($num > 0)
{
    $num = $num - 2;
    sleep(2);
    foreach my $ext (@smallextensions, $bigext)
    {
	my $exit_code = system('grep', '-q', '\\bfile(',  "$filestem$ext.eout1");
	if(0 == $exit_code)
	{
	    `grep 'SZS status' $filestem$ext.eout1 |tail -n1 > $filestem.status`;
	    exec('grep', '\\bfile(',  "$filestem$ext.eout1");
	    exit 0;
	}
    }
}

`grep 'SZS status' $filestem$bigext.eout1 |tail -n1 > $filestem.status`;

